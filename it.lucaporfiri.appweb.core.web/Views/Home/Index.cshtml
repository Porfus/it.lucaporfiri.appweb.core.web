@using it.lucaporfiri.appweb.core.web.ViewModels
@model DashboardViewModel
@{
    var subtitle = DateTime.Now.Hour < 12 && DateTime.Now.Hour > 4 ? "Buongiorno, Riccardo" 
    : DateTime.Now.Hour < 19 && DateTime.Now.Hour >=12  
    ? "Buon pomeriggio, Riccardo" : "Buonasera, Riccardo";

    ViewData["Title"] = "Home Page";

}
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtus Coaching Dashboard</title>
</head>
<body data-theme="dark">

    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="header-logo">
                <p> @subtitle</p>
            </div>
            <div class="header-logo">
                <h1><i class="fas fa-dumbbell"></i>Gestione Atleti - Panoramica Generale</h1>
            </div>
            <button class="theme-switcher" id="theme-switcher" title="Cambia tema">
                <i class="fas fa-moon"></i><i class="fas fa-sun"></i>
            </button>
        </header>

        <div class="stat-cards">
            <div class="stat-card" onclick="jCaricaTotaleAtleti()" style="cursor:pointer;">
                <div class="stat-card-icon icon-total"><i class="fas fa-users"></i></div>
                <div class="stat-card-info">
                    <div class="value">@Model.AtletiTotale</div>
                    <div class="label">Totale Atleti</div>
                </div>
            </div>
            <div class="stat-card" onclick="jCaricaAtletiAttivi()" style="cursor:pointer;">
                <div class="stat-card-icon icon-active"><i class="fas fa-user-check"></i></div>
                <div class="stat-card-info">
                    <div class="value">@Model.AtletiAttivi</div>
                    <div class="label">Atleti Attivi</div>
                </div>
            </div>
            <div class="stat-card" onclick="jCaricaAbbonamentiScaduti()" style="cursor:pointer;">
                <div class="stat-card-icon icon-expired"><i class="fas fa-calendar-times"></i></div>
                <div class="stat-card-info">
                    <div class="value">@Model.AbbonamentiScaduti</div>
                    <div class="label">Abbonamenti Scaduti</div>
                </div>
            </div>
            <div class="stat-card" onclick="jCaricaSchedeScadute()" style="cursor:pointer;">
                <div class="stat-card-icon icon-expired"><i class="fas fa-file-excel"></i></div>
                <div class="stat-card-info">
                    <div class="value">@Model.SchedeScadute</div>
                    <div class="label">Schede Scadute</div>
                </div>
            </div>
        </div>

        <section class="main-content">
            <h2><i class="fas fa-list-ul"></i> Lista di Lavoro</h2>
            <div class="table-controls">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Cerca atleta per nome...">
            </div>
            <table id="atleti-dashboard-table" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>Atleta</th>
                        <th>Categoria</th>
                        <th>Abbonamento</th>
                        <th>Scheda</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="atleti-table-body">
                </tbody>
            </table>
            <div class="main-actions">
                <a href="/Atleta/Index" class="btn btn-secondary"><i class="fas fa-list"></i> Lista Atleti</a>
                <a href="/Abbonamento/Create" class="btn btn-secondary"><i class="fas fa-calendar-plus"></i> Nuovo Abbonamento</a>
                <a href="/Atleta/Create" class="btn btn-primary"><i class="fas fa-user-plus"></i> Nuovo Atleta</a>
            </div>
        </section>

        <section class="critical-section">
            <h2><i class="fas fa-triangle-exclamation"></i> Riepilogo Situazioni Critiche</h2>
            <div class="critical-alerts-list">
                 @if (Model.AlertAtleti != null)
                {
                    @foreach (var alert in Model.AlertAtleti)
                    {
                        <div class="alert-card priority-@alert.Tipo">
                            <div class="alert-card-header">
                                <strong>@alert.Nome</strong>
                                <a href="/Atleta/Details/@alert.IdCliente"><i class="fas fa-arrow-right"></i></a>
                            </div>
                            <div class="alert-card-body">
                                @if (alert.AbbonamentoScaduto)
                                {
                                    <p class="status-abbonamento-scaduto"><i class="fas fa-fire"></i> Abbonamento Scaduto</p>
                                }
                                @if (alert.SchedaScaduta)
                                {
                                    <p class="status-scheda-scaduta"><i class="fas fa-file-excel"></i> Scheda Scaduta</p>
                                }
                                @if (alert.AbbonamentoInScadenza)
                                {
                                    <p class="status-in-scadenza"><i class="fas fa-hourglass-start"></i> Abbonamento in scadenza</p>
                                }
                                @if (alert.SchedaInScadenza)
                                {
                                    <p class="status-in-scadenza"><i class="fas fa-calendar-days"></i> Scheda in scadenza</p>
                                }
                            </div>
                        </div>
                    }
                } 
            </div>
        </section>

    </div>

	<script>
		const themeSwitcher = document.getElementById('theme-switcher');
		const body = document.body;
		const applyTheme = (theme) => { body.setAttribute('data-theme', theme); localStorage.setItem('theme', theme); };
		const toggleTheme = () => { const newTheme = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light'; applyTheme(newTheme); };
		themeSwitcher.addEventListener('click', toggleTheme);
		const savedTheme = localStorage.getItem('theme');
		const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
		if (savedTheme) { applyTheme(savedTheme); } else if (prefersDark) { applyTheme('dark'); } else { applyTheme('light'); }
	</script>
	<script>
		function jCaricaAtletiAttivi() {
			window.location.href = '/Atleta/Index?soloAttivi=true';
		}
        function jCaricaTotaleAtleti(){
            window.location.href = '/Atleta/Index';
        }
        function jCaricaAbbonamentiScaduti(){
            window.location.href = '/Abbonamento/Index?soloScaduti=true';
        }
        function jCaricaSchedeScadute(){
            window.location.href = '/Scheda/Index?soloScadute=true';
        }
	</script>
    @section Scripts {
        <script>
            $(document).ready(function () {
                var table = $('#atleti-dashboard-table').DataTable({
                    "processing": true,     // Mostra un messaggio "Processing..." durante il caricamento
                    "serverSide": true,     // Abilita la modalità server-side
                    "filter": false,        // Disabilitiamo il filtro di default perché usiamo il nostro
                    "ajax": {
                        "url": '/Atleta/FiltraRicerca', 
                        "type": "POST",
                        "datatype": "json",
                        "data": function (d) {
                            // Aggiungi parametri custom alla richiesta
                            d.filtroNome = $('#searchInput').val(); 
                        }
                    },
                    "columns": [
                        { "data": "nomeCompleto", "name": "NomeCompleto", "className": "dt-body-left" },
                        { 
                            "data": "tipo", "name": "Tipo",
                            "render": function (data, type, row){
                                if(data == 0){
                                    return '<span class = "status status-personal">Personal</span>';
                                } else if(data == 1){
                                    return '<span class = "status status-corso">Corso</span>';
                                } else {
                                    return '<span class = "status status-soloscheda">Solo Scheda</span>';
                                }
                            }
                        },
                        {
                            "data": "statoAbbonamento", "name": "StatoAbbonamento",
                            "render": function (data, type, row) {
                                if (data == 0) {
                                    return '<span class="status status-ok">Attivo</span>';
                                } else if(data == 1) {
                                    return '<span class="status status-scaduto">Scaduto</span>';
                                } else {
									return '<span class="status status-notdefined">Non Definito</span>';
                                }
                            }
                        },
                        {
                            "data": "statoScheda", "name": "StatoScheda",
                            "render": function (data, type, row) {
                                if (data == 0) {
                                    return '<span class="status status-ok">Attiva</span>';
                                } else if (data == 1) { 
                                    return '<span class="status status-scaduto">Scaduta</span>';
                                }
                                else {
                                    return '<span class="status status-notdefined">Non Definita</span>';
                                }
                            }
                        },
                        {
                            "data": "id", 
                            "render": function (data, type, row) {
                                return `<a href="/Atleta/Details/${data}" class="btn-details">Dettagli</a>`;
                            },
                            "orderable": false 
                        }
                    ],
                    // Traduzioni in italiano per i controlli della tabella
                    "language": {
                        "processing": "Caricamento...",
                        "lengthMenu": "Mostra _MENU_ elementi",
                        "zeroRecords": "Nessun risultato trovato",
                        "info": "Mostra da _START_ a _END_ di _TOTAL_ elementi",
                        "infoEmpty": "Nessun elemento disponibile",
                        "infoFiltered": "(filtrato da _MAX_ elementi totali)",
                        "search": "Cerca:",
                        "paginate": {
                            "first": "Primo",
                            "previous": "Precedente",
                            "next": "Successivo",
                            "last": "Ultimo"
                        }
                    }
                });

                // Event listener per il tuo input di ricerca personalizzato
                let debounceTimer;
                $('#searchInput').on('keyup', function () {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(function () {
                        table.ajax.reload(); // Ricarica i dati della tabella
                    }, 300); // Aspetta 400ms prima di inviare la richiesta
                });
            });
        </script>
    }
    

</body>
</html>